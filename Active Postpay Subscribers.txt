SELECT DISTINCT SUB_IDENTITY as MSISDN,
decode(payment_mode,0,'PREPAID',1,'POSTPAID',2,'HYBRID') PAY_TYPE, CUST_SEGMENT,
--offering_name, offer_flag,
(CASE WHEN NETWORK_TYPE='1' THEN 'GSM'
      WHEN NETWORK_TYPE='2' THEN 'CDMA'
      WHEN NETWORK_TYPE='3' THEN 'ADSL'
      WHEN NETWORK_TYPE='4' THEN 'FIXED VOICE'
      WHEN NETWORK_TYPE='5' THEN 'WIMAX'
      WHEN NETWORK_TYPE='6' THEN 'VOIP'
      WHEN NETWORK_TYPE='A' THEN 'FIXED DATA'
      WHEN NETWORK_TYPE='D' THEN 'ISDN'
      WHEN NETWORK_TYPE='B' THEN 'HOSTED SERVICE'
      ELSE NETWORK_TYPE END) NETWORK_TYPE,
--R_ACCT_CODE BILLING_ACCOUNT,ACCT_CODE PAYMENT_ACCOUNT,acct_name,
(CASE
WHEN STATUS=1 THEN 'IDLE'
WHEN STATUS=2 AND SUBSTR(STATUS_DETAIL,2,1)<>'0' THEN 'SUSPENDED' -- MISSING CLAIMING
WHEN STATUS=2 AND SUBSTR(STATUS_DETAIL,1,7)='0000000' THEN 'ACTIVE'
WHEN STATUS=2 AND SUBSTR(STATUS_DETAIL,1,1)<>'0' THEN 'SUSPENDED' -- CUSTOMER REQUEST
WHEN STATUS=2 AND SUBSTR(STATUS_DETAIL,3,1)<>'0' THEN 'LOCKED' -- DUE TO ARREARS
WHEN STATUS=2 AND SUBSTR(STATUS_DETAIL,4,1)<>'0' THEN 'LOCKED' -- CREDIT CONTROL
WHEN STATUS=2 AND SUBSTR(STATUS_DETAIL,5,1)<>'0' THEN 'LOCKED' -- CHANGE OF LIFE CYCLE
WHEN STATUS=2 AND SUBSTR(STATUS_DETAIL,6,1)<>'0' THEN 'SUSPENDED' -- OPERATOR REQUEST
WHEN STATUS=2 AND SUBSTR(STATUS_DETAIL,7,1)<>'0' THEN 'SUSPENDED' -- BLACKLIST
WHEN STATUS=3 THEN 'INACTIVE' -- DUE TO INACTIVITY FOR 90 DAYS 
WHEN STATUS=4 AND SUBSTR(STATUS_DETAIL,1,1)<>'0' THEN 'SUSPENDED' --the customer applies for suspension
WHEN STATUS=4 AND SUBSTR(STATUS_DETAIL,2,1)<>'0' THEN 'SUSPENDED' --suspension is due to claiming missing
WHEN STATUS=4 AND SUBSTR(STATUS_DETAIL,3,1)<>'0' THEN 'LOCKED' -- suspension is due to arrears
WHEN STATUS=4 AND SUBSTR(STATUS_DETAIL,4,1)<>'0' THEN 'LOCKED' --suspension is due to credit control
WHEN STATUS=4 AND SUBSTR(STATUS_DETAIL,5,1)<>'0' THEN 'LOCKED' --suspension is due to natural change of life cycle
WHEN STATUS=4 AND SUBSTR(STATUS_DETAIL,6,1)<>'0' THEN 'LOCKED' --the operator requests suspension
WHEN STATUS=4 AND SUBSTR(STATUS_DETAIL,7,1)<>'0' THEN 'SUSPENDED' --suspension is due to blacklist
WHEN STATUS=8 THEN 'PRE DEACTIVE'
WHEN STATUS=9 THEN 'DEACTIVATED'
ELSE 'UKN'
END) STATUS 
--,offering_id , substr(eff_date,1,8) effective_date , substr(exp_date,1,8) expiry_date, substr(create_time,1,8) create_date
FROM 
(SELECT M.*,ROW_NUMBER() OVER (PARTITION BY SUB_IDENTITY ORDER BY CREATE_TIME DESC, offer_flag asc) X FROM VFG_ODM.CBS_F_SUBS_ALL_MASTER_INFO M
WHERE M.TM_ID = 20200930 and M.NETWORK_TYPE = '1'
) 
WHERE X = 1 and status not in (1,8,9) and payment_mode = 1
order by sub_identity
;
